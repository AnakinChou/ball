// -*- Mode: C++; tab-width: 2; -*-
// vi: set ts=2:
//
// $Id: HINFile_test.C,v 1.23 2003/05/08 10:11:53 oliver Exp $

#include <BALL/CONCEPT/classTest.h>

///////////////////////////

#include <BALL/FORMAT/HINFile.h>
#include <BALL/KERNEL/system.h>
#include <BALL/KERNEL/PTE.h>

///////////////////////////

START_TEST(HINFile, "$Id: HINFile_test.C,v 1.23 2003/05/08 10:11:53 oliver Exp $")

/////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////

using namespace BALL;

HINFile* ptr;

CHECK(HINFile::HINFile())
	ptr = new HINFile;
	TEST_NOT_EQUAL(ptr, 0)
RESULT


CHECK(HINFile::~HINFile())
  delete ptr;
RESULT

HINFile hin;

CHECK(HINFile::getTemperature() const )
  TEST_REAL_EQUAL(hin.getTemperature(), 0.0)
RESULT

CHECK(HINFile::getPeriodicBoundary() const )
	Box3 box3(0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
	TEST_EQUAL(hin.getPeriodicBoundary(), box3)
RESULT


CHECK(HINFile::HINFile(const String& filename, File::OpenMode open_mode = std::ios::in))
  hin = HINFile("data/HINFile_test.hin");
  TEST_EQUAL(hin.isValid(), true)
RESULT

System system;
CHECK(HINFile::read(System& system))
  hin.read(system);
	hin.reopen();
	Vector3 position(0.59038, -0.410275, -0.860515);
  TEST_EQUAL(hin.isValid(), true)
  TEST_EQUAL(system.countAtoms(), 648)
  TEST_EQUAL(system.countMolecules(), 216)
	ABORT_IF(system.countAtoms() == 0)
	TEST_EQUAL(system.getAtom(0)->getName(), "O")
  TEST_EQUAL(system.getAtom(0)->getElement(), PTE["O"])
	TEST_REAL_EQUAL(system.getAtom(0)->getCharge(), -0.834)
  TEST_EQUAL(system.getAtom(0)->getPosition(), position)
  TEST_REAL_EQUAL(system.getAtom(0)->getRadius(), 1.4)
  TEST_EQUAL(system.getAtom(0)->countBonds(), 2) 

  TEST_NOT_EQUAL(system.getAtom(1)->getRadius(), 0)
	PRECISION(0.001)
	TEST_REAL_EQUAL(hin.getTemperature(), 297.5626)
	TEST_REAL_EQUAL(hin.getPeriodicBoundary().a.x, -9.35068)
	TEST_REAL_EQUAL(hin.getPeriodicBoundary().a.y, -9.35068)
	TEST_REAL_EQUAL(hin.getPeriodicBoundary().a.z, -9.35068)
	TEST_REAL_EQUAL(hin.getPeriodicBoundary().b.x, 9.35068)
	TEST_REAL_EQUAL(hin.getPeriodicBoundary().b.y, 9.35068)
	TEST_REAL_EQUAL(hin.getPeriodicBoundary().b.z, 9.35068)
	PRECISION(1e-5)

	System S2;
	HINFile hin2("data/AlaGlySer.hin");
	hin2 >> S2;
	TEST_EQUAL(S2.countAtoms(), 31)
	TEST_EQUAL(S2.countProteins(), 1)
	TEST_EQUAL(S2.countResidues(), 3)
	TEST_EQUAL(S2.countChains(), 1)
	TEST_EQUAL(S2.countMolecules(), 1)
	TEST_EQUAL(S2.countBonds(), 30)
RESULT

CHECK(HINFile::write(const System& system))
  String filename;
  NEW_TMP_FILE(filename)
  HINFile hin2(filename, std::ios::out);
	hin2.write(system);
  TEST_FILE_REGEXP(filename.c_str(), "data/HINFile_test2.hin")
RESULT

CHECK(HINFile::HINFile& operator >> (System& system))
	System system2;
  hin >> system2;
	TEST_EQUAL(system.countAtoms(), system2.countAtoms())
RESULT


CHECK(HINFile::hasPeriodicBoundary() const )
	TEST_EQUAL(hin.hasPeriodicBoundary(), true)
RESULT


CHECK(HINFile::HINFile& operator << (const System& system))
  String filename;
  NEW_TMP_FILE(filename)
  HINFile hin2(filename, std::ios::out);
  hin2 << system;
  TEST_FILE_REGEXP(filename.c_str(), "data/HINFile_test2.hin")

	// test whether the name truncation works: it should truncate
	// the name of an atom containing whitespaces to the first field
	NEW_TMP_FILE(filename)
	system.beginAtom()->setName("NAME TEST");
	HINFile hin3(filename, std::ios::out);
	CAPTURE_OUTPUT_LEVEL(LogStream::WARNING)
		hin3 << system;
	COMPARE_OUTPUT("HINFile::write: truncated atom name 'NAME TEST' to 'NAME'.\n")
	TEST_FILE_REGEXP(filename.c_str(), "data/HINFile_test3.hin")
RESULT

CHECK(robust reading)	
	HINFile f("data/HINFile_test4.hin");
	System S;
	TEST_EXCEPTION(Exception::ParseError, f >> S)
	f.close();
RESULT

/////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////

END_TEST
