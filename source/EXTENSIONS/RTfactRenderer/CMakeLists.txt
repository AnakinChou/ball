PROJECT(RTFACT_PLUGIN)

SET(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${PROJECT_SOURCE_DIR}/cmake)

FIND_PACKAGE(RTfact)

IF(NOT RTFACT_FOUND)
	MESSAGE(STATUS "RTfact not found. Disabling the RTfact renderer plugin.")
	RETURN()
ENDIF()

## RTfact
IF (NOT CMAKE_COMPILER_IS_INTELCXX)
	IF(NOT TBB_FOUND)
		FIND_PACKAGE(TBB)
	ENDIF()

	IF(NOT TBB_FOUND)
		MESSAGE(STATUS "Could not find TBB. Disabling the RTfact renderer plugin")
		RETURN()
	ENDIF()

	IF(NOT ${BALL_LICENSE_GPL} AND ${TBB_VERSION_MAJOR} VERSION_LESS 2017)
		MESSAGE(STATUS "TBB versions <2017 require BALL_LICENSE_GPL. Disabling the RTfact renderer plugin")
		RETURN()
	ENDIF()

	INCLUDE_DIRECTORIES(${TBB_INCLUDE_DIRS})
	BALL_COMBINE_LIBS(TBB_LIBRARIES "${TBB_LIBRARIES}" "${TBB_DEBUG_LIBRARIES}")
	LIST(REMOVE_DUPLICATES TBB_LIBRARIES)

	SET(BALL_HAS_TBB TRUE)
ENDIF()

INCLUDE_DIRECTORIES(${PROJECT_BINARY_DIR}/include)

SET(DIRECTORY source)
### list all filenames of the directory here
SET(SOURCES_LIST
	${DIRECTORY}/rtfactPlugin.C
	${DIRECTORY}/rtfactRenderer.C
	${DIRECTORY}/rtfactRenderSetup.C
)

SET(RCC_SOURCES_LIST
	${DIRECTORY}/logo.qrc
)

SET(DIRECTORY include)

### the list of all files requiring a moc run
SET(MOC_SOURCES_LIST
	${DIRECTORY}/rtfactPlugin.h
)

QT5_WRAP_CPP(MOC_OUTFILES ${MOC_SOURCES_LIST})
QT5_ADD_RESOURCES(RCC_OUTFILES ${RCC_SOURCES_LIST})
QT5_WRAP_UI(UIC_OUTFILES ${UI_SOURCES_LIST})

INCLUDE_DIRECTORIES(${PROJECT_SOURCE_DIR}/include)
INCLUDE_DIRECTORIES(${PROJECT_BINARY_DIR})
INCLUDE_DIRECTORIES(${RTFACT_INCLUDE_PATH})

ADD_DEFINITIONS(${QT_DEFINITIONS})
ADD_DEFINITIONS(-DQT_PLUGIN)
ADD_DEFINITIONS(-DQT_NO_DEBUG)
ADD_DEFINITIONS(-DQT_SHARED)

LINK_DIRECTORIES(${RTFACT_LIBRARY_DIRS})

ADD_LIBRARY(pluginRTfactRenderer SHARED
	${SOURCES_LIST}
	${MOC_OUTFILES}
	${RCC_OUTFILES}
	${UIC_OUTFILES}
)

SET_TARGET_PROPERTIES(pluginRTfactRenderer PROPERTIES PREFIX "")

IF(NOT APPLE)
	INSTALL(TARGETS pluginRTfactRenderer
		COMPONENT "${COMPONENT_PLUGINS}"
		RUNTIME DESTINATION "${BALL_PLUGIN_INSTALL_DIRECTORY}"
		LIBRARY DESTINATION "${BALL_PLUGIN_INSTALL_DIRECTORY}"
	)

	IF(WIN32)
		IF(QT_DEPLOY_EXECUTABLE)
			INSTALL(CODE "EXECUTE_PROCESS(COMMAND ${QT_DEPLOY_EXECUTABLE} \$\{CMAKE_INSTALL_PREFIX\}/${CMAKE_INSTALL_BINDIR}/pluginRTfactRenderer.dll)"
COMPONENT "Unspecified")
		ENDIF()
	ENDIF()
ENDIF()

TARGET_LINK_LIBRARIES(pluginRTfactRenderer BALL VIEW ${RTFACT_LIBRARIES})
